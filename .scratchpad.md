# Olera Web Scratchpad

## Current Focus
Stabilizing overlay/modal rendering across all discovery and browse pages; cleaning up authenticated navbar UX

## In Progress
- Overlay stability validation across all browse/discover pages and roles
- Consistent minimum profile requirements enforcement across all engagement flows

## Next Up
- Validate overlay stability end-to-end across all discovery pages (caregiver, family, org roles)
- Enforce `isProfileShareable()` / `getProfileCompletionGaps()` uniformly across all discovery pages and provider-family / provider-provider request flows
- Verify paywall triggers correctly after free engagement limit is reached
- Audit remaining `transition-all` usage site-wide for any other transform-related issues

## Session Log

### 2026-02-03
- **Root-caused overlay flashing/jumping across all discovery pages** after 4 rounds of investigation:
  - Round 1: Changed Supabase `.single()` to `.maybeSingle()` to eliminate HTTP 406 errors on ConnectButton existing-connection checks (11 cards = 11x 406 storms). Removed broken Footer links (`/terms`, `/privacy`, `/pricing`, `/auth/signup`) that caused Next.js prefetch 404 storms. Did not resolve flashing.
  - Round 2: Stabilized Modal useEffect by introducing `onCloseRef` pattern so `handleKeyDown` has zero deps and effect only re-runs on `isOpen` change (not every render). Added scrollbar width compensation (`paddingRight`) when setting `body.overflow = "hidden"`. Did not resolve flashing.
  - Round 3: Stabilized useEffect dependencies across all 6 browse/discover pages — replaced object references (`activeProfile`, `user`) with stable string IDs (`profileId`, `userId`) to prevent re-fetch cascades when `refreshAccountData()` created new object references. Made PortalSidebar sticky (`sticky top-16 h-[calc(100vh-4rem)]`) to fix Settings/ProfileSwitcher disappearing below fold. Changed ConnectButton from always-mounted 3x Modals to conditional mounting of only the active modal. Bumped Modal z-index to `z-[60]` above Navbar's `z-50`. Added `forwards` fill-mode to CSS animations. Did not resolve flashing.
  - **Round 4 (true root cause found):** CSS `transform` on card hover (`hover:-translate-y-0.5`) creates a new containing block per the CSS spec, which causes `position: fixed` descendants (Modal) to behave as `position: absolute` relative to the transformed card ancestor. This was the architectural issue — not React state, lifecycle, or styling.
- **Implemented two-pronged fix for overlay instability:**
  1. Portaled Modal to `document.body` via `createPortal` so it always renders outside any transformed ancestor — `position: fixed` now correctly references the viewport
  2. Removed `hover:-translate-y-0.5` and `transition-all` from all 7 card components across browse and discover pages, replaced with `transition-shadow` (shadow-only hover effect that doesn't create containing blocks)
- **Rewrote ConnectButton state management** (earlier in session, from prior context): replaced 3 independent boolean modal states with a single discriminated union `ModalState` (`closed | confirm | success | upgrade | incomplete`), added local optimistic counter for immediate paywall gating, awaited `refreshAccountData()` after connection creation
- **Cleaned up authenticated navbar:** removed care category dropdowns (Home Care, Assisted Living, Memory Care, Nursing Home, etc.) for all authenticated users — families, caregivers, and organizations now see only the Olera logo and account avatar dropdown. Categories remain for unauthenticated visitors browsing the marketplace.
- **Rewrote calendar page** (earlier in session, from prior context): added visual weekly calendar strip with Mon-Sun day cells, week navigation, day selection with appointment dot indicators, "Propose a Time" primary CTA, compact/full card variants, "All Connections" list below calendar

### 2026-02-02
- Started Vercel setup process
- Created scratchpad to track progress
- Created `feature/vercel-setup` branch

## Decisions Made
- Using Vercel for deployment (hosting platform choice)
- **Modal portaling via `createPortal(document.body)`** is the correct architectural pattern for any component using `position: fixed` that may be rendered inside cards or other elements with CSS transforms. This is a CSS spec constraint, not a React issue.
- **No CSS `transform` on card ancestors that contain modals.** `hover:-translate-y-0.5` replaced with shadow-only hover effects (`transition-shadow`). Transform-based hover effects are visually similar but architecturally incompatible with fixed-position descendants.
- **Authenticated navbar is minimal:** no care category navigation for logged-in users regardless of role. The portal sidebar provides all navigation context once authenticated.
- **ConnectButton uses discriminated union state machine** instead of multiple boolean flags, to prevent impossible states (e.g., two modals open simultaneously).
- **useEffect dependencies use stable string IDs** (not object references) to prevent re-fetch cascades triggered by `refreshAccountData()` creating new object instances with identical data.

## Notes
- Project is a Next.js 16 App Router app with React 19, TypeScript, Tailwind CSS, and Supabase
- The CSS containing block issue (`transform` breaking `position: fixed`) is a well-known spec behavior but easy to miss when modals are rendered as children of interactive card components. Any future component that uses `position: fixed` and might be nested inside a transformed ancestor should use `createPortal`.
- All secondary fixes (`.maybeSingle()`, stable useEffect deps, `onCloseRef`, scrollbar compensation, conditional modal mounting, animation fill-mode, z-index fix, sidebar stickiness) were real improvements even though they weren't the primary cause of the flashing. They addressed legitimate bugs: 406 error storms, unnecessary re-renders, scroll-lock layout shift, excessive DOM nodes, and sidebar layout issues.
- The `transition-all` class is especially dangerous because it transitions ALL CSS properties including `transform`, `opacity`, and `filter` — all of which create new containing blocks or stacking contexts. Prefer specific transition properties (`transition-shadow`, `transition-colors`) unless you explicitly need to animate transforms.
- Supabase `.single()` returns HTTP 406 when zero rows match; `.maybeSingle()` returns `null` cleanly. Always use `.maybeSingle()` for queries that may return zero results.
